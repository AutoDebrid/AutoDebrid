<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation Control Panel</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .controls, .status-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        button { background-color: #007bff; color: white; padding: 12px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button.stop { background-color: #dc3545; }
        button.stop:hover { background-color: #c82333; }
        button.action { background-color: #28a745; }
        button.action:hover { background-color: #218838; }
        .status-box { background: #e9ecef; padding: 15px; border-radius: 5px; text-align: center; }
        .status-box strong { display: block; margin-bottom: 5px; font-size: 18px; }
        .status-indicator { font-weight: bold; }
        .status-running { color: #28a745; }
        .status-stopped { color: #dc3545; }
        #log-viewer { background-color: #222; color: #eee; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-wrap: break-word; height: 400px; overflow-y: scroll; padding: 15px; border-radius: 5px; margin-top: 20px; font-size: 14px; }
        #response { margin-top: 15px; padding: 10px; background: #e2e3e5; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Automation Control Panel</h1>

    <h2>System Status</h2>
    <div class="status-panel">
        <div class="status-box">
            <strong>JDownloader Watcher</strong>
            <span id="jd-status" class="status-indicator">Loading...</span>
        </div>
        <div class="status-box">
            <strong>Movie Organizer</strong>
            <span id="movie-status" class="status-indicator">Loading...</span>
        </div>
    </div>
    
    <h2>Controls</h2>
    <div class="controls">
        <button onclick="postData('/start_jdownloader')">Start JDownloader Watcher</button>
        <button class="stop" onclick="postData('/stop_jdownloader')">Stop JDownloader Watcher</button>
        <button class="action" onclick="postData('/process_movies')">Process Movies Now</button>
    </div>
    <div id="response"></div>

    <h2>Live Logs</h2>
    <pre id="log-viewer">Loading logs...</pre>
</div>

<script>
    const responseDiv = document.getElementById('response');
    const jdStatusSpan = document.getElementById('jd-status');
    const movieStatusSpan = document.getElementById('movie-status');
    const logViewer = document.getElementById('log-viewer');

    // Function to post data to an endpoint
    async function postData(url) {
        try {
            const response = await fetch(url, { method: 'POST' });
            const result = await response.json();
            responseDiv.textContent = `Status: ${result.status}`;
            fetchStatus(); // Refresh status after action
        } catch (error) {
            console.error('Error:', error);
            responseDiv.textContent = 'An error occurred.';
        }
    }

    // Function to update status indicators
    function updateStatus(jdStatus, movieStatus) {
        jdStatusSpan.textContent = jdStatus;
        jdStatusSpan.className = `status-indicator ${jdStatus === 'Running' ? 'status-running' : 'status-stopped'}`;
        
        movieStatusSpan.textContent = movieStatus;
        movieStatusSpan.className = `status-indicator ${movieStatus === 'Running' ? 'status-running' : 'status-stopped'}`;
    }

    // Function to fetch system status
    async function fetchStatus() {
        try {
            const response = await fetch('/status');
            const data = await response.json();
            updateStatus(data.jdownloader_status, data.movie_organizer_status);
        } catch (error) {
            console.error('Error fetching status:', error);
            updateStatus('Error', 'Error');
        }
    }

    // Function to fetch logs
    async function fetchLogs() {
        try {
            const response = await fetch('/stream_logs');
            const data = await response.json();
            // Check if the content has changed to avoid unnecessary screen redraws
            if (logViewer.textContent !== data.log) {
                logViewer.textContent = data.log;
                // Auto-scroll to the bottom
                logViewer.scrollTop = logViewer.scrollHeight;
            }
        } catch (error) {
            console.error('Error fetching logs:', error);
            logViewer.textContent = 'Error loading logs.';
        }
    }

    // Initial calls and intervals
    fetchStatus();
    fetchLogs();
    setInterval(fetchStatus, 5000);  // Refresh status every 5 seconds
    setInterval(fetchLogs, 3000);    // Refresh logs every 3 seconds
</script>

</body>
</html>